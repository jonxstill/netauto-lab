---
- name: Produce Datamodel output
  hosts: all
  connection: local
  gather_facts: false
  vars:
   - output: "{{inventory_dir}}/output"

  tasks:
    - name: Create Output Directory
      tags:
        - dataonly
        - reportonly
      run_once: true
      file:
        path: "{{ output }}"
        state: directory

    - name: Read Data Model
      include_vars:
        file: "datamodel.yaml"
        name: dmparams

    - name: Set Validation Facts
      set_fact:
        loopbackprefix_invalid: "{{ dmparams.loopbackprefix|ipsubnet == dmparams.loopbackprefix }}"
        p2pprefix_invalid: "{{ dmparams.p2pprefix|ipsubnet == dmparams.p2pprefix }}"
        p2pprefix_insufficient: "{{ (dmparams.p2pprefix|ipaddr('size') / dmparams.p2pprefix|ipsubnet(dmparams.p2plength, 0)|ipaddr('size')) < (dmparams.maxspines * dmparams.leaves) }}"

    - name: Data Model Validation
      run_once: true
      assert:
        that:
          - "p2pprefix_invalid != false"
          - "p2pprefix_insufficient == false"
        msg: "Validation Failed"

    # - name: Generate Device YAML File
    #   tags:
    #     - dataonly
    #   template:
    #     src: "datamodel.j2"
    #     dest: "{{output}}/{{inventory_hostname}}.yml"
